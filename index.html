<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAMO - Instrumento de Avalia√ß√£o Multifatorial da Obesidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAcZzh-e_s3pbpVi_4bJn-Wi1HxtaIph9g",
          authDomain: "iamo-beta.firebaseapp.com",
          projectId: "iamo-beta",
          storageBucket: "iamo-beta.firebasestorage.app",
          messagingSenderId: "548076489654",
          appId: "1:548076489654:web:e91a21fe68438a101acf17"
        };

        const app = initializeApp(firebaseConfig);

        // Nota: Se a config acima estiver vazia, o app funcionar√° apenas localmente sem salvar no banco
        let db;
        let auth;
        try {
            // Inicializa diretamente, sem verifica√ß√£o de placeholder
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Autentica√ß√£o an√¥nima para permitir escrita no banco sem login do usu√°rio
            signInAnonymously(auth).then(() => {
                console.log("Firebase conectado e autenticado anonimamente.");
            }).catch((error) => {
                console.error("Erro na autentica√ß√£o an√¥nima:", error);
            });

        } catch (e) {
            console.error("Erro ao inicializar Firebase:", e);
        }

        // Exp√µe as fun√ß√µes para o escopo global para serem usadas pelo script principal
        window.salvarRespostasFirebase = async (dadosCompletos) => {
            if (!db) {
                console.warn("Banco de dados n√£o configurado, pulando salvamento.");
                return false;
            }
            try {
                // Salva na cole√ß√£o "respostas_iamo"
                const docRef = await addDoc(collection(db, "respostas_iamo"), dadosCompletos);
                console.log("Documento salvo com ID: ", docRef.id);
                return true;
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                alert("Houve um erro ao salvar seus dados online, mas o resultado ser√° gerado normalmente.");
                return false;
            }
        };
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .form-radio-custom {
            appearance: none;
            -webkit-appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }

        .form-radio-custom:checked {
            border-color: #3b82f6;
        }

        .form-radio-custom:checked::after {
            content: '';
            width: 0.8em;
            height: 0.8em;
            border-radius: 50%;
            background: #3b82f6;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .form-checkbox-custom {
            appearance: none;
            -webkit-appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            display: inline-block;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }

        .form-checkbox-custom:checked {
            border-color: #3b82f6;
            background-color: #3b82f6;
        }

        .form-checkbox-custom:checked::after {
            content: '‚úì';
            font-size: 1.2em;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .scale-radio:checked+label {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        select:invalid {
            color: #9ca3af;
        }

        select option {
            color: #111827;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .collapsible-content.expanded {
            max-height: 2000px; /* Aumentei para garantir que textos longos apare√ßam */
        }

        .arrow-icon {
            transition: transform 0.3s ease-in-out;
        }

        .arrow-icon.expanded {
            transform: rotate(180deg);
        }

        /* Loading spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="mb-8 flex justify-center items-center gap-4">
            <img src="iamo_logo.png" alt="IAMO Logo" class="h-16 w-16 sm:h-20 sm:w-20">
            <div class="text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">IAMO</h1>
                <p class="text-lg text-gray-600">Instrumento de Avalia√ß√£o Multifatorial da Obesidade</p>
            </div>
        </header>

        <main id="questionnaire-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <form id="iamo-form">
                <!-- Etapa 0: Dados Iniciais -->
                <div class="step active" data-step="0">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Dados Iniciais</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <p class="text-sm text-blue-700">
                            <strong>Aviso de Privacidade:</strong> Os dados preenchidos neste formul√°rio ser√£o utilizados anonimamente para fins estat√≠sticos deste estudo. Ao clicar em "Ver Resultado", voc√™ concorda com o envio dessas informa√ß√µes.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo (ou Iniciais)</label>
                            <input type="text" id="nome" name="nome"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="idade" class="block text-sm font-medium text-gray-700 mb-1">Idade (anos)</label>
                            <input type="number" id="idade" name="idade" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="sexo" class="block text-sm font-medium text-gray-700 mb-1">Sexo</label>
                            <select id="sexo" name="sexo" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Selecione a op√ß√£o</option>
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                                <option value="nao_informar">Prefiro n√£o informar</option>
                            </select>
                        </div>
                        <div>
                            <label for="peso" class="block text-sm font-medium text-gray-700 mb-1">Peso Atual
                                (kg)</label>
                            <input type="number" step="0.1" id="peso" name="peso" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="altura" class="block text-sm font-medium text-gray-700 mb-1">Altura (m)</label>
                            <input type="number" step="0.01" id="altura" name="altura" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Ex: 1.75">
                        </div>
                        <div>
                            <label for="tabagismo"
                                class="block text-sm font-medium text-gray-700 mb-1">Tabagismo</label>
                            <select id="tabagismo" name="tabagismo" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Selecione a op√ß√£o</option>
                                <option value="nunca_fumou">Nunca fumou</option>
                                <option value="ex_fumante">Ex-fumante</option>
                                <option value="fumante_ocasional">Fumante ocasional</option>
                                <option value="fumante_diario">Fumante di√°rio</option>
                            </select>
                        </div>
                        <div>
                            <label for="etilismo" class="block text-sm font-medium text-gray-700 mb-1">Consumo de
                                √Ålcool</label>
                            <select id="etilismo" name="etilismo" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Selecione a op√ß√£o</option>
                                <option value="nao_consome">N√£o consome</option>
                                <option value="raramente">Raramente (menos de 1x/m√™s)</option>
                                <option value="socialmente_semanal">Socialmente (1-2x/semana)</option>
                                <option value="frequente_semanal">Frequente (3-5x/semana)</option>
                                <option value="diario">Di√°rio</option>
                            </select>
                        </div>
                        <div>
                            <label for="ocupacao" class="block text-sm font-medium text-gray-700 mb-1">Ocupa√ß√£o</label>
                            <input type="text" id="ocupacao" name="ocupacao"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="horas_trabalho" class="block text-sm font-medium text-gray-700 mb-1">Horas
                                trabalhadas por semana</label>
                            <input type="number" id="horas_trabalho" name="horas_trabalho"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="escolaridade"
                                class="block text-sm font-medium text-gray-700 mb-1">Escolaridade</label>
                            <select id="escolaridade" name="escolaridade" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Selecione a op√ß√£o</option>
                                <option value="fundamental_incompleto">Fundamental Incompleto</option>
                                <option value="fundamental_completo">Fundamental Completo</option>
                                <option value="medio_incompleto">M√©dio Incompleto</option>
                                <option value="medio_completo">M√©dio Completo</option>
                                <option value="superior_incompleto">Superior Incompleto</option>
                                <option value="superior_completo">Superior Completo</option>
                            </select>
                        </div>
                        <div>
                            <label for="transporte" class="block text-sm font-medium text-gray-700 mb-1">Principal meio
                                de transporte</label>
                            <select id="transporte" name="transporte" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected>Selecione a op√ß√£o</option>
                                <option value="a_pe_bicicleta">A p√© / Bicicleta</option>
                                <option value="transporte_publico">Transporte P√∫blico</option>
                                <option value="carro_moto">Carro / Moto</option>
                                <option value="app">Transporte por App</option>
                                <option value="trabalho_em_casa">Trabalho em casa</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quem prepara as principais
                                refei√ß√µes?</label>
                            <div class="mt-2 flex flex-wrap gap-x-6 gap-y-2">
                                <label class="flex items-center"><input type="radio" name="preparaRefeicoes"
                                        value="eu_mesmo" class="form-radio-custom mr-2"><span class="text-sm">Eu
                                        mesmo</span></label>
                                <label class="flex items-center"><input type="radio" name="preparaRefeicoes"
                                        value="familia" class="form-radio-custom mr-2"><span
                                        class="text-sm">C√¥njuge/Fam√≠lia</span></label>
                                <label class="flex items-center"><input type="radio" name="preparaRefeicoes"
                                        value="delivery" class="form-radio-custom mr-2"><span class="text-sm">Compro
                                        fora/Delivery</span></label>
                                <label class="flex items-center"><input type="radio" name="preparaRefeicoes"
                                        value="outro" class="form-radio-custom mr-2"><span
                                        class="text-sm">Outro</span></label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Etapa 1: Question√°rio IAMO -->
                <div class="step" data-step="1">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700">Question√°rio IAMO</h2>
                    <div id="questions-wrapper" class="space-y-8">
                        <!-- As quest√µes ser√£o injetadas aqui via JS -->
                    </div>
                </div>
            </form>
            <div class="mt-8 flex justify-between">
                <button id="prev-btn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50"
                    disabled>Anterior</button>
                <button id="next-btn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-200">Iniciar
                    Question√°rio</button>
                <button id="submit-btn"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-200 items-center justify-center"
                    style="display: none;">
                    <span class="btn-text">Ver Resultado</span>
                </button>
            </div>
        </main>

        <section id="results-container" class="hidden mt-8">
            <div id="report-to-print" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <!-- 1. DADOS DO PACIENTE -->
                <div id="patient-data-section">
                    <h2 class="text-3xl font-bold text-center mb-2 text-gray-800">Resultado da Avalia√ß√£o</h2>
                    <p id="patient-name-report" class="text-center text-xl text-gray-600 mb-8"></p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                        <div id="chart-container" class="h-80 lg:h-96">
                            <canvas id="radarChart"></canvas>
                        </div>
                        <div id="score-summary">
                            <!-- Scores ser√£o inseridos aqui -->
                        </div>
                    </div>
                    <div id="imc-visualizer" class="mt-8"></div>
                </div>
                <hr class="my-8 border-gray-200">

                <!-- Conte√∫do do Relat√≥rio -->
                <div id="report-content" class="space-y-8">
                    <!-- As se√ß√µes do relat√≥rio ser√£o injetadas aqui -->
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="pdf-btn"
                    class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 mb-2 sm:mb-0">Gerar
                    Relat√≥rio em PDF</button>
                <button id="export-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 ml-0 sm:ml-4 mb-2 sm:mb-0">Baixar C√≥pia (JSON)</button>
                <button id="restart-btn"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-200 ml-0 sm:ml-4">Nova
                    Avalia√ß√£o</button>
            </div>
            <div id="save-status-msg" class="text-center mt-4 text-sm text-gray-500"></div>
        </section>
    </div>

    <script>
        // --- ESTRUTURA DAS QUEST√ïES ---
        const questions = [
            // Foco 1: Atividade F√≠sica
            { q: 1, focus: "AF", type: 'radio', text: 'Em uma semana comum, quantos dias voc√™ faz pelo menos 20 minutos de atividade f√≠sica VIGOROSA? (Ex: correr, jogar futebol, aula de gin√°stica pesada - que aumentam MUITO a respira√ß√£o/batimentos card√≠acos)', options: [{ text: 'Nenhum dia', value: 3 }, { text: '1-2 dias', value: 2 }, { text: '3-4 dias', value: 1 }, { text: '5 dias ou mais', value: 0 }] },
            { q: 2, focus: "AF", type: 'radio', text: 'Em uma semana comum, quantos dias voc√™ faz pelo menos 30 minutos de atividade f√≠sica MODERADA ou caminhada? (Ex: caminhar r√°pido, pedalar leve, dan√ßar, servi√ßos dom√©sticos mais ativos - que aumentam LEVEMENTE a respira√ß√£o/batimentos)', options: [{ text: 'Nenhum dia', value: 3 }, { text: '1-2 dias', value: 2 }, { text: '3-4 dias', value: 1 }, { text: '5 dias ou mais', value: 0 }] },
            { q: 3, focus: "AF", type: 'radio', text: 'Em um dia comum da semana, quanto tempo voc√™ passa sentado(a) (trabalhando, estudando, assistindo TV, usando computador/celular - sem incluir o tempo dormindo)?', options: [{ text: '10 horas ou mais', value: 3 }, { text: 'Entre 7 e 9 horas', value: 2 }, { text: 'Entre 4 e 6 horas', value: 1 }, { text: 'Menos de 4 horas', value: 0 }] },
            { q: 4, focus: "AF", type: 'radio', text: 'Se voc√™ n√£o √© t√£o ativo(a) quanto gostaria, qual o principal motivo? Marque apenas uma op√ß√£o.', options: [{ text: 'Falta de tempo', value: 4, id: 'falta_tempo' }, { text: 'Falta de motiva√ß√£o / Cansa√ßo / Des√¢nimo', value: 4, id: 'falta_motivacao' }, { text: 'Dores / Limita√ß√£o f√≠sica', value: 4, id: 'dores_limitacao' }, { text: 'Falta de ar', value: 4, id: 'apneia_limitacao' }, { text: 'Falta de dinheiro / Acesso a locais seguros', value: 4, id: 'falta_dinheiro' }, { text: 'N√£o gosto de exerc√≠cio / Acho chato', value: 4, id: 'nao_gosto' }, { text: 'J√° sou suficientemente ativo(a)', value: 0, id: 'suf_ativo' }] },

            // Foco 2: Alimenta√ß√£o
            { q: 5, focus: "AL", type: 'radio', text: 'Com que frequ√™ncia voc√™ consome alimentos ultraprocessados (ex: refrigerantes, salgadinhos, biscoitos recheados, macarr√£o instant√¢neo)?', options: [{ text: 'Todos ou quase todos os dias', value: 3 }, { text: '4 a 6 vezes por semana', value: 2 }, { text: '1 a 3 vezes por semana', value: 1 }, { text: 'Raramente ou nunca', value: 0 }] },
            { q: 6, focus: "AL", type: 'radio', text: 'Com que frequ√™ncia voc√™ consome frutas, legumes ou verduras?', options: [{ text: 'Raramente ou nunca', value: 3 }, { text: 'Alguns dias na semana', value: 2 }, { text: 'Na maioria dos dias, mas n√£o em todas refei√ß√µes', value: 1 }, { text: 'Diariamente, na maioria das refei√ß√µes', value: 0 }] },
            { q: 7, focus: "AL", type: 'radio', text: 'Com que frequ√™ncia voc√™ consome bebidas a√ßucaradas (refrigerantes, sucos de caixa, achocolatados, caf√© com a√ß√∫car)?', options: [{ text: 'Todos ou quase todos os dias', value: 3 }, { text: '4 a 6 vezes por semana', value: 2 }, { text: '1 a 3 vezes por semana', value: 1 }, { text: 'Raramente ou nunca', value: 0 }] },
            { q: 8, focus: "AL", type: 'radio', text: 'Quantos copos de √°gua pura voc√™ bebe por dia? Considere que cada copo equivale a 200 ml de √°gua.', options: [{ text: '0 a 3 copos (menos de 600 ml)', value: 3 }, { text: '4 a 7 copos (entre 600 ml e 1,4 l)', value: 2 }, { text: '8 a 10 copos (entre 1,6 e 2 litros)', value: 1 }, { text: 'Mais de 10 copos (mais do que 2 litros)', value: 0 }] },
            { q: 9, focus: "AL", type: 'radio', text: 'Voc√™ costuma comer (ou comer mais) em resposta a situa√ß√µes como: ver um an√∫ncio de comida, sentir um cheiro bom, estar em um evento social com comida dispon√≠vel, mesmo sem fome real?', options: [{ text: 'Quase sempre', value: 3 }, { text: 'Frequentemente', value: 2 }, { text: '√Äs vezes', value: 1 }, { text: 'Nunca ou raramente', value: 0 }] },
            { q: 10, focus: "AL", type: 'radio', text: 'Voc√™ sente que perde o controle sobre o que ou o quanto come?', options: [{ text: 'Quase sempre', value: 5 }, { text: 'Frequentemente', value: 3 }, { text: '√Äs vezes', value: 1 }, { text: 'Nunca ou raramente', value: 0 }] },

            // Foco 3: Sa√∫de Mental
            { q: 11, focus: "SM", type: 'radio', text: 'Nas √∫ltimas 2 semanas, com que frequ√™ncia voc√™ se sentiu triste, deprimido(a) ou sem esperan√ßa?', options: [{ text: 'Todos os dias', value: 6 }, { text: 'Quase todos os dias', value: 4 }, { text: 'Metade dos dias', value: 2 }, { text: 'Poucos dias', value: 1 }, { text: 'Nenhuma vez', value: 0 }] },
            { q: 12, focus: "SM", type: 'radio', text: 'Nas √∫ltimas 2 semanas, com que frequ√™ncia voc√™ se sentiu nervoso(a), ansioso(a) ou muito preocupado(a)?', options: [{ text: 'Todos os dias', value: 6 }, { text: 'Quase todos os dias', value: 4 }, { text: 'Metade dos dias', value: 2 }, { text: 'Poucos dias', value: 1 }, { text: 'Nenhuma vez', value: 0 }] },
            { q: 13, focus: "SM", type: 'radio', text: 'Como voc√™ se sente em rela√ß√£o √† sua apar√™ncia f√≠sica atualmente?', options: [{ text: 'Muito insatisfeito(a)', value: 4 }, { text: 'Insatisfeito(a)', value: 3 }, { text: 'Neutro / Indiferente', value: 2 }, { text: 'Satisfeito(a)', value: 1 }, { text: 'Muito satisfeito(a)', value: 0 }] },
            { q: 14, focus: "SM", type: 'radio', text: 'No seu dia a dia atual, com que frequ√™ncia voc√™ se sente estressado(a) ou sobrecarregado(a)?', options: [{ text: 'Todos os dias', value: 4 }, { text: 'Quase sempre', value: 3 }, { text: 'Metade dos dias', value: 2 }, { text: 'Poucas vezes', value: 1 }, { text: 'Raramente ou nunca', value: 0 }] },
            { q: 15, focus: "SM", type: 'radio', text: 'Em geral, como voc√™ avalia a qualidade do seu sono?', options: [{ text: 'P√©ssima (durmo muito pouco e/ou meu sono n√£o √© reparador)', value: 6 }, { text: 'Ruim (durmo mal, acordo cansado ou tenho ins√¥nia frequente)', value: 4 }, { text: 'Mais ou menos (tenho dificuldade em algumas noites ou n√£o descanso bem)', value: 2 }, { text: 'Boa (demoro a dormir ou acordo √† noite, mas descanso)', value: 1 }, { text: '√ìtima (durmo bem e acordo descansado)', value: 0 }] },
            { q: 16, focus: "SM", type: 'checkbox', text: 'Quais das seguintes estrat√©gias voc√™ j√° utilizou para perder peso por pelo menos 3 meses? (Marque todas que se aplicam)', options: [{ text: 'Dietas muito restritivas', value: 1, id: 'dieta' }, { text: 'Rem√©dios para emagrecer (com ou sem receita)', value: 1, id: 'remedio' }, { text: 'Ch√°s ou compostos "naturais" para emagrecer', value: 1, id: 'chas' }, { text: 'Cirurgia bari√°trica', value: 1, id: 'bariatrica' }, { text: 'Exerc√≠cio f√≠sico', value: 1, id: 'exercicio' }, { text: 'Nenhuma dessas', value: 0, id: 'nenhumatentativa' }] },
            { q: 17, focus: "SM", type: 'radio', text: 'Comida √© uma fonte de conforto ou uma recompensa para voc√™, principalmente quando se sente triste, ansioso(a), frustrado(a) ou entediado(a)?', options: [{ text: 'Todos os dias', value: 4 }, { text: 'Quase sempre', value: 3 }, { text: 'Metade das vezes', value: 2 }, { text: 'Poucas vezes', value: 1 }, { text: 'Nunca ou raramente', value: 0 }] },

            // Foco 4: Metabolismo / Gen√©tica
            { q: 18, focus: "MG", type: 'radio', text: 'Seus pais ou irm√£os t√™m ou tiveram obesidade?', options: [{ text: 'Sim, e eu tamb√©m tive obesidade na inf√¢ncia', value: 3 }, { text: 'Sim, ambos os pais ou v√°rios irm√£os', value: 2 }, { text: 'Sim, um dos pais ou algum irm√£o', value: 1 }, { text: 'N√£o que eu saiba / Apenas parentes distantes', value: 0 }] },
            { q: 19, focus: "MG", type: 'checkbox', text: 'Voc√™ tem diagn√≥stico de alguma das seguintes condi√ß√µes? (Marque todas que se aplicam)', options: [{ text: 'Hipotireoidismo', value: 2, id: 'hipotireoidismo' }, { text: 'S√≠ndrome dos Ov√°rios Polic√≠sticos (SOP)', value: 2, id: 'sop' }, { text: 'Diabetes (Tipo 1 ou 2)', value: 2, id: 'diabetes' }, { text: 'Hipertens√£o arterial', value: 0, id: 'hipertensao' }, { text: 'Asma / DPOC', value: 2, id: 'asma_dpoc' }, { text: 'Apneia do Sono', value: 2, id: 'apneia' }, { text: 'Menopausa', value: 2, id: 'menopausa' }, { text: 'Fibromialgia / Dor cr√¥nica', value: 2, id: 'fibromialgia' }, { text: 'N√£o sei se tenho', value: 4, id: 'desconhecediagnostico' }, { text: 'N√£o possuo nenhuma dessas doen√ßas', value: 0, id: 'semdiagnostico' }] },
            { q: 20, focus: "MG", type: 'radio', text: 'Voc√™ usa continuamente alguma medica√ß√£o que possa aumentar o peso (ex: corticoides, alguns antidepressivos, antipsic√≥ticos etc)?', options: [{ text: 'Sim, uso uma ou mais', value: 4 }, { text: 'N√£o tenho certeza', value: 1 }, { text: 'N√£o', value: 0 }] },
            { q: 21, focus: "MG", type: 'radio', text: 'Voc√™ sente que tem mais dificuldade para perder peso do que a maioria das pessoas, mesmo se esfor√ßando?', options: [{ text: 'Sim', value: 6 }, { text: 'N√£o', value: 0 }] },

            // Extra: Motiva√ß√£o
            { q: 22, focus: "Extra", type: 'radio-scale', text: 'Em uma escala de 0 (nenhuma) a 10 (muito importante), o qu√£o importante √© para voc√™, NESTE MOMENTO, mudar seus h√°bitos e seu peso?', options: Array.from({ length: 11 }, (_, i) => ({ text: i.toString(), value: i })) },
            { q: 23, focus: "Extra", type: 'radio-scale', text: 'Em uma escala de 0 (nenhuma) a 10 (totalmente confiante), o qu√£o confiante voc√™ se sente de que consegue fazer as mudan√ßas necess√°rias?', options: Array.from({ length: 11 }, (_, i) => ({ text: i.toString(), value: i })) },
            { q: 24, focus: "Extra", type: 'radio', text: 'Qual a sua principal motiva√ß√£o para querer mudar?', options: [{ text: 'Melhorar a sa√∫de / Evitar doen√ßas', value: 'saude' }, { text: 'Melhorar a disposi√ß√£o / Energia', value: 'disposicao' }, { text: 'Melhorar a apar√™ncia / Autoestima', value: 'estetica' }, { text: 'Recomenda√ß√£o m√©dica', value: 'medica' }, { text: 'Outro', value: 'outro' }] },
        ];

        // --- L√ìGICA DO QUESTION√ÅRIO ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('iamo-form');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');
            const restartBtn = document.getElementById('restart-btn');
            const pdfBtn = document.getElementById('pdf-btn');

            let currentStep = 0;
            const totalSteps = 2; // 0 para dados iniciais, 1 para quest√µes
            let currentChart = null;

            function createQuestionHTML(question) {
                const questionWrapper = document.createElement('div');
                questionWrapper.className = 'py-6 border-t';

                const questionHeader = document.createElement('div');
                questionHeader.className = 'flex items-start gap-4 mb-4';
                questionHeader.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-md">${question.q}</div>
                <p class="text-md font-semibold text-gray-800 flex-grow mt-1">${question.text}</p>
            `;
                questionWrapper.appendChild(questionHeader);

                const optionsWrapper = document.createElement('div');
                optionsWrapper.className = 'pl-12';

                if (question.type === 'radio-scale') {
                    optionsWrapper.className += ' flex flex-wrap gap-2 items-center';
                    const legendMin = document.createElement('span');
                    legendMin.className = 'text-sm text-gray-500 mr-2';
                    legendMin.textContent = '0 (Nenhuma)';
                    optionsWrapper.appendChild(legendMin);

                    const scaleContainer = document.createElement('div');
                    scaleContainer.className = 'flex flex-grow justify-center gap-1';

                    question.options.forEach((opt) => {
                        const optionId = `q${question.q}_${opt.value}`;
                        const radioWrapper = document.createElement('div');
                        radioWrapper.innerHTML = `
                        <input type="radio" id="${optionId}" name="q${question.q}" value="${opt.value}" data-score="${opt.value}" class="scale-radio hidden">
                        <label for="${optionId}" class="w-10 h-10 flex items-center justify-center border rounded-lg cursor-pointer transition-colors duration-200 hover:bg-gray-100">${opt.text}</label>
                    `;
                        scaleContainer.appendChild(radioWrapper);
                    });
                    optionsWrapper.appendChild(scaleContainer);

                    const legendMax = document.createElement('span');
                    legendMax.className = 'text-sm text-gray-500 ml-2';
                    legendMax.textContent = '10 (Totalmente)';
                    optionsWrapper.appendChild(legendMax);

                } else {
                    optionsWrapper.className += ' space-y-3';
                    question.options.forEach((opt, index) => {
                        const optionId = `q${question.q}_${index}`;
                        const optionDiv = document.createElement('div');
                        optionDiv.innerHTML = `
                        <label for="${optionId}" class="flex items-center p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                            <input type="${question.type}" id="${optionId}" name="q${question.q}" value="${opt.id || opt.value}" data-score="${question.type === 'radio' ? opt.value : ''}" class="${question.type === 'radio' ? 'form-radio-custom' : 'form-checkbox-custom'} h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                            <span class="ml-3 text-sm text-gray-700">${opt.text}</span>
                        </label>
                    `;
                        optionsWrapper.appendChild(optionDiv);
                    });
                }

                questionWrapper.appendChild(optionsWrapper);
                return questionWrapper;
            }

            function setupQuestions() {
                const questionsWrapper = document.getElementById('questions-wrapper');
                questions.forEach(q => {
                    questionsWrapper.appendChild(createQuestionHTML(q));
                });
            }

            const steps = () => document.querySelectorAll('.step');

            function updateUI() {
                steps().forEach((step, index) => {
                    step.classList.toggle('active', index === currentStep);
                });

                prevBtn.disabled = currentStep === 0;
                nextBtn.style.display = currentStep === totalSteps - 1 ? 'none' : 'inline-block';
                submitBtn.style.display = currentStep === totalSteps - 1 ? 'flex' : 'none'; // Mudado para flex para alinhar spinner
                nextBtn.textContent = currentStep === 0 ? "Iniciar Question√°rio" : "Pr√≥ximo";
            }

            function validateStep() {
                if (currentStep === 0) {
                    const required = ['idade', 'sexo', 'peso', 'altura', 'tabagismo', 'etilismo', 'escolaridade', 'transporte'];
                    let isValid = true;
                    required.forEach(field => {
                        const el = form.querySelector(`[name="${field}"]`);
                        if (!el.value) {
                            el.classList.add('border-red-500');
                            isValid = false;
                        } else {
                            el.classList.remove('border-red-500');
                        }
                    });
                    if (!isValid) alert("Por favor, preencha todos os campos obrigat√≥rios.");
                    return isValid;
                }
                return true;
            }

            nextBtn.addEventListener('click', () => {
                if (!validateStep()) return;
                if (currentStep < totalSteps - 1) {
                    currentStep++;
                    updateUI();
                    window.scrollTo(0, 0);
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateUI();
                    window.scrollTo(0, 0);
                }
            });

            // --- L√ìGICA DE SUBMISS√ÉO MODIFICADA PARA FIREBASE ---
            submitBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                // UX: Loading State
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="loader"></div> Processando...';
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                questions.filter(q => q.type === 'checkbox').forEach(q => {
                    data[`q${q.q}`] = formData.getAll(`q${q.q}`);
                });

                // Calcula os scores primeiro
                const scores = calculateScores(data);
                
                // Prepara objeto para salvar (igual ao export manual)
                const objectToSave = {
                    timestamp: new Date().toISOString(),
                    dados_iniciais: { 
                        nome: data.nome, 
                        idade: data.idade, 
                        sexo: data.sexo, 
                        peso: data.peso, 
                        altura: data.altura, 
                        tabagismo: data.tabagismo, 
                        etilismo: data.etilismo, 
                        ocupacao: data.ocupacao, 
                        horas_trabalho: data.horas_trabalho, 
                        transporte: data.transporte, 
                        escolaridade: data.escolaridade,
                        preparaRefeicoes: data.preparaRefeicoes
                    },
                    respostas: data,
                    scores_percentual: scores
                };

                // Tenta salvar no Firebase
                let saved = false;
                if (window.salvarRespostasFirebase) {
                    saved = await window.salvarRespostasFirebase(objectToSave);
                }

                const statusMsg = document.getElementById('save-status-msg');
                if (saved) {
                    statusMsg.textContent = "Dados salvos com seguran√ßa.";
                    statusMsg.className = "text-center mt-4 text-sm text-green-600";
                } else {
                    statusMsg.textContent = "Dados processados localmente.";
                    statusMsg.className = "text-center mt-4 text-sm text-gray-500";
                }

                // Restaura bot√£o e mostra resultados
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;

                showResultsUI(scores, data);
                window.scrollTo(0, 0);
            });

            restartBtn.addEventListener('click', () => {
                window.location.reload();
            });

            function calculateScores(data) {
                const scores = { AF: 0, AL: 0, SM: 0, MG: 0 };
                const maxScores = { AF: 13, AL: 20, SM: 43, MG: 41 };

                // Processa bot√µes de R√°dio e Escala
                questions.filter(q => q.type === 'radio' || q.type === 'radio-scale').forEach(q => {
                    const selectedOption = document.querySelector(`input[name="q${q.q}"]:checked`);
                    if (selectedOption && q.focus !== 'Extra') {
                        const score = parseInt(selectedOption.dataset.score, 10) || 0;
                        scores[q.focus] += score;
                    }
                });

                // Processa Checkboxes
                questions.filter(q => q.type === 'checkbox').forEach(q => {
                    const values = data[`q${q.q}`] || [];
                    let questionScore = 0;
                    values.forEach(value => {
                        const option = q.options.find(opt => opt.id === value);
                        if (option) { questionScore += option.value; }
                    });
                    if (q.q === 19) { questionScore = Math.min(questionScore, 10); }

                    if (q.focus !== 'Extra') {
                        scores[q.focus] += questionScore;
                    }
                });

                // Regras especiais de pontua√ß√£o
                if (data.q4 === 'falta_motivacao') scores.SM += 4;
                if (data.q4 === 'dores_limitacao') scores.MG += 4;
                const q15score = parseInt(data.q15 || '0', 10);
                scores.MG += q15score;

                const finalScores = {
                    AF: Math.round((scores.AF / maxScores.AF) * 100),
                    AL: Math.round((scores.AL / maxScores.AL) * 100),
                    SM: Math.round((scores.SM / maxScores.SM) * 100),
                    MG: Math.round((scores.MG / maxScores.MG) * 100)
                };

                if (data.q11 === '6') {
                    finalScores.SM = Math.max(finalScores.SM, 80);
                }
                if (data.q18 === '3') {
                    finalScores.MG = Math.max(finalScores.MG, 70);
                }
                
                return finalScores;
            }

            function showResultsUI(scores, data) {
                 const reportData = generateReport(scores, data);
                 
                 // Configura Bot√£o de PDF
                 pdfBtn.onclick = () => generatePDF();
                 
                 // Configura Bot√£o de Exportar Manual (Backup)
                 document.getElementById('export-btn').onclick = () => exportData(scores, data);

                 displayResults(scores, data, reportData);
            }

            function generateStrengths(data) {
                const strengths = [];
                if (data.q8 <= 1) {
                    strengths.push({
                        icon: 'üíß',
                        title: 'Excelente hidrata√ß√£o',
                        text: 'Existe um √≥timo n√≠vel de hidrata√ß√£o. Este √© um dos h√°bitos mais importantes para a sa√∫de metab√≥lica e o bom funcionamento do corpo.'
                    });
                }
                if (data.q1 <= 2 || data.q2 <= 1) {
                    strengths.push({
                        icon: 'üí™',
                        title: 'Atividade f√≠sica regular',
                        text: 'H√° o h√°bito de se movimentar regularmente, o que √© uma grande vantagem e um passo muito importante. O objetivo pode ser pensar em como otimizar ou adicionar mais variedade a essa pr√°tica j√° conquistada.'
                    });
                }
                if (data.preparaRefeicoes === 'eu_mesmo' || data.preparaRefeicoes === 'familia') {
                    strengths.push({
                        icon: 'üç≥',
                        title: 'Controle sobre o preparo dos alimentos',
                        text: 'O fato de preparar as pr√≥prias refei√ß√µes (ou ter algu√©m da fam√≠lia que o fa√ßa) √© uma grande vantagem, permitindo total controle sobre os ingredientes e a forma de preparo. Pode-se explorar receitas pr√°ticas e saud√°veis.'
                    });
                }
                if (data.q7 === 0) {
                    strengths.push({
                        icon: 'üëç',
                        title: 'Poucas bebidas a√ßucaradas',
                        text: '√ìtimo h√°bito de evitar bebidas a√ßucaradas, uma das medidas de maior impacto positivo para a sa√∫de metab√≥lica. Manter essa escolha √© uma grande vit√≥ria no dia a dia.'
                    });
                }
                if (data.transporte === 'a_pe_bicicleta') {
                    strengths.push({
                        icon: 'üö≤',
                        title: 'Transporte ativo',
                        text: 'Utilizar transporte ativo, como caminhar ou andar de bicicleta, √© uma excelente forma de incorporar mais movimento ao dia a dia, beneficiando a sa√∫de cardiovascular e metab√≥lica.'
                    });
                }
                if (data.q4 === 'suf_ativo') {
                    strengths.push({
                        icon: 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
                        title: 'Percep√ß√£o de atividade suficiente',
                        text: 'H√° uma percep√ß√£o positiva sobre o n√≠vel de atividade f√≠sica, indicando que j√° existe um bom h√°bito estabelecido. Manter esse n√≠vel √© importante para a sa√∫de geral.'
                    });
                }
                if (data.q5 <= 1 && data.q6 <= 1 && data.q7 <= 1) {
                    strengths.push({
                        icon: 'ü•ó',
                        title: 'Padr√£o alimentar saud√°vel',
                        text: 'H√° um padr√£o alimentar saud√°vel, com baixo consumo de ultraprocessados e bebidas a√ßucaradas, e boa ingest√£o de frutas, legumes e verduras. Manter esses h√°bitos √© fundamental para a sa√∫de geral.'
                    });
                }
                if (data.q24 === 'saude' || data.q24 === 'disposicao') {
                    strengths.push({
                        icon: 'üíñ',
                        title: 'Motiva√ß√£o voltada para sa√∫de e disposi√ß√£o',
                        text: 'A motiva√ß√£o principal para mudan√ßa est√° focada na melhoria da sa√∫de ou da energia, o que √© um excelente ponto de partida para adotar h√°bitos mais saud√°veis e sustent√°veis.'
                    });
                }
                if (data.q22 >= 7 && data.q23 >= 7) {
                    strengths.push({
                        icon: 'üöÄ',
                        title: 'Pronto para a a√ß√£o',
                        text: 'H√° uma alta motiva√ß√£o e confian√ßa para fazer mudan√ßas, o que √© um excelente ponto de partida para adotar h√°bitos mais saud√°veis e sustent√°veis.'
                    });
                }
                if (data.q15 <= 1) {
                    strengths.push({
                        icon: 'üò¥',
                        title: 'Boa qualidade do sono',
                        text: 'H√° uma boa qualidade do sono, o que √© fundamental para a sa√∫de mental e f√≠sica. Manter esse h√°bito contribui significativamente para o bem-estar geral.'
                    });
                }
                return strengths;
            }

            function displayResults(scores, data, reportData) {
                document.getElementById('questionnaire-container').classList.add('hidden');
                document.getElementById('results-container').classList.remove('hidden');
                document.getElementById('patient-name-report').textContent = data.nome || 'Paciente';

                const scoreSummary = document.getElementById('score-summary');
                scoreSummary.innerHTML = '';
                const reportContent = document.getElementById('report-content');
                reportContent.innerHTML = '';

                // Renderiza o visualizador de IMC
                const imcVisualizerContainer = document.getElementById('imc-visualizer');
                if (reportData.imc) {
                    const imcValue = parseFloat(reportData.imc);
                    const minIMC = 15, maxIMC = 45;
                    let imcPercent = ((imcValue - minIMC) / (maxIMC - minIMC)) * 100;
                    imcPercent = Math.max(0, Math.min(100, imcPercent));

                    imcVisualizerContainer.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 text-center">Classifica√ß√£o do IMC</h4>
                        <div class="relative w-full pt-8 pb-6 px-2">
                            <div class="h-3 rounded-full bg-gradient-to-r from-blue-300 via-yellow-300 to-red-400"></div>
                            <div id="imc-marker" class="absolute top-0 transition-all duration-500" style="left: ${imcPercent}%;">
                                <div class="relative flex flex-col items-center">
                                    <div class="bg-gray-800 text-white text-sm font-bold px-2 py-1 rounded-md -mt-1 shadow-lg">${reportData.imc}</div>
                                    <div class="w-2 h-2 bg-gray-800 transform rotate-45 -mt-1"></div>
                                    <div class="w-0.5 h-3 bg-gray-800"></div>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2 -mx-2">
                                <span class="w-1/4 text-center">Normal</span>
                                <span class="w-1/4 text-center">Sobrepeso</span>
                                <span class="w-1/4 text-center">Obesidade I</span>
                                <span class="w-1/4 text-center">Obesidade II+</span>
                            </div>
                        </div>
                    </div>
                `;
                    document.getElementById('imc-marker').style.transform = 'translateX(-50%)';
                }

                // Renderiza as barras de progresso dos focos
                const focusNames = { AF: 'Atividade F√≠sica', AL: 'Alimenta√ß√£o', SM: 'Sa√∫de Mental', MG: 'Metabolismo/Gen√©tica' };
                const focusColors = { AF: 'green', AL: 'yellow', SM: 'blue', MG: 'orange' };
                Object.entries(scores).forEach(([key, value]) => {
                    const color = focusColors[key];
                    const isHigh = value > 60;
                    const scoreEl = document.createElement('div');
                    scoreEl.className = 'mb-3';
                    scoreEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm text-gray-700">${focusNames[key]}</span>
                        <span class="font-bold text-lg ${isHigh ? `text-${color}-600` : `text-${color}-600`}">${value}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="${isHigh ? `bg-${color}-500` : `bg-${color}-500`} h-4 rounded-full" style="width: ${value}%"></div>
                    </div>
                `;
                    scoreSummary.appendChild(scoreEl);
                });

                // Renderiza o Gr√°fico Radar
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (currentChart) {
                    currentChart.destroy();
                }
                currentChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['AF', 'AL', 'SM', 'MG'],
                        datasets: [{
                            label: 'Pontua√ß√£o do Foco (%)',
                            data: Object.values(scores),
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14, weight: '500' } } } },
                        plugins: { legend: { display: false } }
                    }
                });

                // --- CONSTRU√á√ÉO DO RELAT√ìRIO ---
                let finalHTML = '';

                // 2. DIAGN√ìSTICO MULTIFATORIAL
                if (reportData.narrative) {
                    finalHTML += `
                <div id="narrative-section">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Diagn√≥stico Multifatorial</h3>
                    <div class="bg-gray-50 p-5 rounded-lg shadow-inner">
                        <p class="text-gray-700 leading-relaxed">${reportData.narrative}</p>
                    </div>
                </div>
                `;
                }

                // 3. PONTOS FORTES
                const strengths = generateStrengths(data);
                if (strengths.length > 0) {
                    let strengthsHTML = `<div id="strengths-section">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Pontos Fortes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                    strengths.forEach(strength => {
                        strengthsHTML += `
                        <div class="bg-green-50 border border-green-200 p-4 rounded-lg flex items-start gap-4">
                            <span class="text-2xl">${strength.icon}</span>
                            <div>
                                <p class="font-semibold text-green-800">${strength.title}</p>
                                <p class="text-sm text-green-700">${strength.text}</p>
                            </div>
                        </div>
                    `;
                    });
                    strengthsHTML += `</div></div>`;
                    finalHTML += strengthsHTML;
                }

                // 4. SINAIS DE ALERTA (Expans√≠vel)
                if (reportData.alerts.length > 0) {
                    finalHTML += `
                    <div id="alerts-section" class="bg-red-50 border border-red-200 rounded-lg">
                        <button class="collapsible-trigger w-full flex justify-between items-center p-4 text-left">
                            <h3 class="text-xl font-semibold text-red-800">Sinais de Alerta</h3>
                            <svg class="arrow-icon w-6 h-6 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="collapsible-content">
                            <div class="px-4 pb-4 space-y-3">
                            ${reportData.alerts.map(item => `
                                <div class="bg-white p-3 rounded-md shadow-sm">
                                    <p class="font-semibold text-red-700">${item.title}</p>
                                    <p class="text-sm text-gray-600">${item.text}</p>
                                </div>
                            `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                }

                // 5. ORIENTA√á√ïES (Expans√≠vel)
                if (reportData.orientations.length > 0) {
                    finalHTML += `
                    <div id="orientations-section" class="bg-blue-50 border border-blue-200 rounded-lg">
                        <button class="collapsible-trigger w-full flex justify-between items-center p-4 text-left">
                            <h3 class="text-xl font-semibold text-blue-800">Orienta√ß√µes</h3>
                            <svg class="arrow-icon w-6 h-6 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="collapsible-content">
                             <div class="px-4 pb-4 space-y-3">
                                ${reportData.orientations.map(item => `
                                    <div class="bg-white p-3 rounded-md shadow-sm">
                                        <p class="font-semibold text-blue-700">${item.title}</p>
                                        <p class="text-sm text-gray-600">${item.text}</p>
                                    </div>
                                `).join('')}
                                ${reportData.professionals.size > 0 ? `
                                    <div class="bg-white p-3 rounded-md shadow-sm mt-4">
                                        <p class="font-semibold text-gray-800">Profissionais que podem ajudar:</p>
                                        <p class="text-sm text-gray-600">${Array.from(reportData.professionals).join(' ‚Ä¢ ')}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                }

                // 6. METAS
                finalHTML += `
                <div id="goals-section">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Metas Iniciais</h3>
                    <div class="bg-purple-50 p-5 rounded-lg shadow-inner space-y-4">
                        <div>
                            <label for="meta1" class="block text-sm font-medium text-gray-700">Meta 1 (algo pequeno e pr√°tico para a pr√≥xima semana):</label>
                            <textarea id="meta1" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="Ex: Caminhar 15 minutos ap√≥s o almo√ßo na segunda, quarta e sexta."></textarea>
                        </div>
                         <div>
                            <label for="meta2" class="block text-sm font-medium text-gray-700">Meta 2 (opcional):</label>
                            <textarea id="meta2" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm" placeholder="Ex: Adicionar uma por√ß√£o de fruta no caf√© da manh√£ todos os dias."></textarea>
                        </div>
                    </div>
                </div>
            `;

                reportContent.innerHTML = finalHTML;

                // Adiciona funcionalidade aos bot√µes expans√≠veis
                document.querySelectorAll('.collapsible-trigger').forEach(trigger => {
                    trigger.addEventListener('click', () => {
                        const content = trigger.nextElementSibling;
                        const arrow = trigger.querySelector('.arrow-icon');
                        content.classList.toggle('expanded');
                        arrow.classList.toggle('expanded');
                    });
                });

            }

            function generateReport(scores, data) {
                let alerts = [];
                let orientations = [];
                let professionals = new Set();
                const imc = data.peso && data.altura ? (data.peso / (data.altura * data.altura)).toFixed(2) : null;

                // --- GERA A NARRATIVA ---
                const narrative = generateNarrative(scores, data);

                // --- L√ìGICA DE ALERTAS E ORIENTA√á√ïES ---
                const hasDepressiveSymptoms = parseInt(data.q11, 10) >= 4;
                const hasAnxietySymptoms = parseInt(data.q12, 10) >= 4;
                const hasPoorSleep = parseInt(data.q15, 10) >= 3;
                const hasTriedManyThings = data.q16 && data.q16.length >= 3;
                const motivationDiscrepancy = parseInt(data.q22, 10) > 7 && parseInt(data.q23, 10) < 5;
                const gatilhoFibromialgia = data.q19?.includes('desconhecediagnostico') && data.q11 >= '4' && data.q4 === 'dores_limitacao'

                // --- SINAIS DE ALERTA ---

                if (parseFloat(imc) >= 40) {
                    alerts.push({ title: 'Obesidade grau III', text: 'O IMC indica obesidade grau III, o que est√° associado a um risco significativamente aumentado de complica√ß√µes de sa√∫de. √â essencial uma avalia√ß√£o m√©dica detalhada para planejamento de interven√ß√µes adequadas.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Endocrinologista');
                }
                if (data.escolaridade === 'sem_escolaridade' || data.escolaridade === 'fundamental_incompleto') {
                    alerts.push({ title: 'Barreira de letramento', text: 'O baixo n√≠vel educacional pode dificultar a compreens√£o e ades√£o a orienta√ß√µes de sa√∫de. Estrat√©gias de comunica√ß√£o simplificadas, com checagem de entendimento, e apoio adicional podem ser necess√°rios para garantir o sucesso do tratamento.' });
                    professionals.add('Assistente Social').add('Agente Comunit√°rio de Sa√∫de');
                }
                if (data.preparaRefeicoes === 'delivery') {
                    alerts.push({ title: 'Depend√™ncia de delivery', text: 'A falta de preparo das pr√≥prias refei√ß√µes dificulta o controle de ingredientes, por√ß√µes e custos. Risco aumentado de consumo de ultraprocessados e gorduras.' });
                    professionals.add('Nutricionista');
                }
                if (data.q1 === 3 && data.q2 === 3) {
                    alerts.push({ title: 'Sedentarismo severo', text: 'O n√≠vel de atividade f√≠sica √© extremamente baixo, o que impacta negativamente a sa√∫de metab√≥lica e cardiovascular. Uma avalia√ß√£o m√©dica √© recomendada antes de iniciar qualquer programa de exerc√≠cios.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Educador F√≠sico');
                }
                if (data.q3 === 3) {
                    alerts.push({ title: 'Alto tempo sedent√°rio di√°rio', text: 'O tempo prolongado em atividades sedent√°rias (mais que 10 horas sentado) √© um fator de risco independente para v√°rias condi√ß√µes metab√≥licas e cardiovasculares, mesmo para quem se exercita. Estrat√©gias para reduzir o tempo sentado e incorporar pausas ativas s√£o essenciais.' });
                    professionals.add('Educador F√≠sico').add('M√©dico de Fam√≠lia');
                }
                if (data.q4 === 'dores_limitacao') {
                    alerts.push({ title: 'Barreira f√≠sica ao exerc√≠cio', text: 'Presen√ßa de dores ou limita√ß√µes f√≠sicas como principal barreira para a atividade f√≠sica. √â crucial uma avalia√ß√£o m√©dica e/ou fisioter√°pica para investigar a causa, garantir um diagn√≥stico correto e encontrar modalidades de exerc√≠cio seguras e adaptadas.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Fisioterapeuta');
                }
                if (data.q4 === 'nao_gosto') {
                    alerts.push({ title: 'Barreira afetiva ao exerc√≠cio', text: 'A falta de gosto ou interesse pela atividade f√≠sica √© uma barreira comum. Estrat√©gias motivacionais, experimenta√ß√£o de diferentes modalidades e apoio psicol√≥gico podem ser necess√°rios para superar essa resist√™ncia. Abordagens tradicionais ("tem que fazer") tendem a falhar; o foco deve ser em encontrar prazer no movimento.' });
                    professionals.add('Psic√≥logo').add('Educador F√≠sico');
                }
                if (data.q4 === 'apneia_limitacao' && data.q19?.includes('desconhecediagnostico')) {
                    alerts.push({ title: 'Investiga√ß√£o respirat√≥ria', text: 'Foi relatado que a falta de ar √© uma barreira para o exerc√≠cio f√≠sico. Pode-se tratar apenas de pouco condicionamento f√≠sico, por√©m √© interessante descartar a possibilidade de doen√ßas respirat√≥rias.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Pneumologista');
                }
                if (data.q19?.includes('apneia') && hasPoorSleep) {
                    alerts.push({ title: 'Apneia do sono e m√° qualidade do sono', text: 'A combina√ß√£o de diagn√≥stico de apneia do sono e percep√ß√£o de sono ruim √© um grande sinal de alerta. O tratamento inadequado da apneia impacta severamente o metabolismo, aumenta o risco cardiovascular e dificulta o controle do peso. A ades√£o ao tratamento (ex: CPAP) √© priorit√°ria.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Especialista em Sono');
                }
                if (data.q10 >= 2) {
                    alerts.push({ title: 'Percep√ß√£o de perda de controle alimentar', text: 'O relato de perda de controle alimentar frequente pode ser um sinal de transtorno da compuls√£o alimentar. √â um ponto que merece aten√ß√£o e deve ser avaliado por um profissional de sa√∫de mental e nutricionista com abordagem comportamental.' });
                    professionals.add('Psic√≥logo').add('Nutricionista').add('M√©dico de Fam√≠lia');
                }
                if (hasDepressiveSymptoms || hasAnxietySymptoms) {
                    alerts.push({ title: 'Sintomas significativos de humor/ansiedade', text: 'Foram relatados sintomas de humor deprimido ou ansiedade de forma frequente. Estes sintomas podem impactar profundamente a motiva√ß√£o e os h√°bitos de vida. Uma avalia√ß√£o de sa√∫de mental √© fortemente recomendada para diagn√≥stico e tratamento adequados.' });
                    professionals.add('Psic√≥logo').add('Psiquiatra');
                }
                if (data.q20 === '4') {
                    alerts.push({ title: 'Uso de medica√ß√£o com impacto no peso', text: 'O uso cont√≠nuo de certas medica√ß√µes foi indicado. √â importante revisar a prescri√ß√£o com o(a) m√©dico(a) respons√°vel para avaliar se existem alternativas com menor impacto metab√≥lico ou se o manejo do peso precisa de estrat√©gias espec√≠ficas.' });
                    professionals.add('M√©dico de Fam√≠lia').add('M√©dico Especialista');
                }
                if (data.q19?.includes('desconhecediagnostico') && data.q21 === '6') {
                    alerts.push({ title: "Investiga√ß√£o metab√≥lica recomendada", text: "O paciente relata dificuldade em perder peso e desconhece seu estado de sa√∫de em rela√ß√£o a poss√≠veis doen√ßas metab√≥licas. Sugere-se solicitar exames laboratoriais (ex: perfil lip√≠dico, glicemia de jejum, TSH) para investigar causas secund√°rias que possam estar influenciando o ganho de peso." });
                    professionals.add('M√©dico de Fam√≠lia');
                }
                if (data.q14 >= 3 && data.q5 === '3' && data.q19?.includes('hipertensao')) {
                    alerts.push({ title: 'Risco cardiometab√≥lico elevado', text: 'A combina√ß√£o de estresse cr√¥nico com alto consumo de ultraprocessados √© um potente gatilho para desregula√ß√£o metab√≥lica e aumento do risco cardiovascular. O manejo do estresse √© uma prioridade terap√™utica.' });
                    professionals.add('Psic√≥logo').add('Nutricionista').add('M√©dico de Fam√≠lia');
                }
                if (data.q19?.includes('sop') && data.q21 === '4') {
                    alerts.push({ title: "Desafio metab√≥lico espec√≠fico: S√≠ndrome dos Ov√°rios Polic√≠sticos (SOP)", text: "A paciente com SOP e dificuldade percebida em perder peso necessita de uma abordagem direcionada. O tratamento deve focar no controle da resist√™ncia √† insulina, com orienta√ß√£o nutricional e de atividade f√≠sica espec√≠ficas para a condi√ß√£o." });
                    professionals.add('M√©dico de Fam√≠lia').add('Nutricionista').add('Endocrinologista');
                }
                if (data.q10 > 2 && data.q17 > 2) {
                    alerts.push({ title: 'Risco de transtorno da compuls√£o alimentar', text: 'A avalia√ß√£o evidenciou epis√≥dios de perda de controle alimentar combinados com o uso da comida para regula√ß√£o emocional. Esta combina√ß√£o √© um forte indicativo de poss√≠vel transtorno da compuls√£o alimentar, que requer diagn√≥stico e tratamento espec√≠ficos antes de focar em dietas ou perda de peso. A abordagem punitiva ou restritiva √© contraindicada.' });
                    professionals.add('Psic√≥logo').add('Nutricionista').add('M√©dico de Fam√≠lia').add('Psiquiatra');
                }
                if (data.q11 === '6') {
                    alerts.push({ title: 'Sintomas graves de depress√£o', text: 'Foram identificados sintomas depressivos de alta frequ√™ncia e intensidade. Estes sintomas s√£o condi√ß√µes de sa√∫de que precisam de tratamento priorit√°rio, pois impactam diretamente a energia, a motiva√ß√£o e a capacidade de realizar mudan√ßas. O manejo do peso torna-se secund√°rio neste momento.' });
                    professionals.add('Psiquiatra').add('Psic√≥logo').add('M√©dico de Fam√≠lia');
                }
                if (data.q15 >= 4) {
                    alerts.push({ title: 'Priva√ß√£o do sono', text: 'A avalia√ß√£o indica uma m√° qualidade do sono severa, o que pode estar associado a dist√∫rbios do sono n√£o diagnosticados (ex: ins√¥nia grave, apneia do sono). <strong>A priva√ß√£o cr√¥nica de sono √© um forte disruptor end√≥crino</strong>: aumenta a grelina (horm√¥nio que d√° a sensa√ß√£o de fome), reduz a leptina (horm√¥nio respons√°vel pela saciedade) e aumenta cortisol (horm√¥nio do estresse, cujos valores elevados e constantes aumentam a glicemia e, consequentemente, o peso). Dificulta muito o emagrecimento.' });
                    professionals.add('Especialista em Sono').add('M√©dico de Fam√≠lia').add('Psic√≥logo');
                }
                if (gatilhoFibromialgia) {
                    alerts.push({ title: "Possibilidade de fibromialgia", text: "A uni√£o de sintomas depressivos e limita√ß√£o para realizar exerc√≠cios f√≠sicos por dores pode indicar a presen√ßa de fibromialgia, portanto recomenda-se investigar essa ou outras causas centrais de dores cr√¥nicas." });
                    professionals.add('M√©dico de Fam√≠lia').add('Reumatologista');
                }
                if (data.q5 >= 2 && data.q6 >= 2 && data.q7 >= 2) {
                    alerts.push({ title: 'Padr√£o alimentar de risco', text: 'O padr√£o alimentar avaliado indica consumo elevado de ultraprocessados, bebidas a√ßucaradas e baixo consumo de frutas, legumes e verduras. Este padr√£o √© inflamat√≥rio e est√° fortemente associado a desregula√ß√£o metab√≥lica, ganho de peso e aumento do risco cardiovascular. Uma reeduca√ß√£o alimentar √© essencial.' });
                    professionals.add('Nutricionista');
                }
                if (data.q14 >= 3) {
                    alerts.push({ title: 'Estresse cr√¥nico elevado', text: 'O n√≠vel de estresse percebido √© muito alto, o que impacta negativamente a sa√∫de metab√≥lica e dificulta o controle do peso (aumento constante dos n√≠veis s√©ricos de cortisol e poss√≠vel comprometimento do sono, por exemplo). Estrat√©gias de manejo do estresse, como t√©cnicas de relaxamento e psicoterapia, s√£o recomendadas.' });
                    professionals.add('Psic√≥logo').add('M√©dico de Fam√≠lia');
                }

                // --- ORIENTA√á√ïES ---

                if (imc >= 35 && !data.q16?.includes('bariatrica')) {
                    let text = `Apesar de n√£o ser a melhor forma de avalia√ß√£o isoladamente, o Minist√©rio da Sa√∫de preconiza que um indiv√≠duo com IMC de ${imc} `;
                    if (imc >= 50) {
                        text += 'deve ser <strong>encaminhado para avalia√ß√£o de cirurgia bari√°trica</strong>, mesmo sem comorbidades ou dois anos de tentativa de tratamento cl√≠nico.';
                    } else if (imc >= 40) {
                        text += 'deve ser encaminhado para avalia√ß√£o de cirurgia bari√°trica, mesmo sem comorbidades, <strong>caso haja falha em tratamento cl√≠nico longitudinal por pelo menos dois anos</strong>.';
                    } else if (data.q19?.includes('hipertensao') || data.q19?.includes('diabetes') || data.q19?.includes('apneia') && data.q21 === '6') {
                        text += 'que possui comorbidades associadas (como foi relatado) deve ser encaminhado para avalia√ß√£o de cirurgia bari√°trica, <strong>caso haja falha em tratamento cl√≠nico longitudinal por pelo menos dois anos</strong>.';
                    } else {
                        text += 'pode considerar a avalia√ß√£o para cirurgia bari√°trica, <strong>caso haja falha em tratamento cl√≠nico longitudinal por pelo menos dois anos</strong> e <strong>seja diagnosticada alguma das seguintes comorbidades</strong>: risco cardiovascular maior que 20% em 10 anos, doen√ßa cardiovascular, hipertens√£o arterial de dif√≠cil controle, diabetes mellitus de dif√≠cil controle, s√≠ndrome da apneia e hipopneia obstrutiva do sono ou doen√ßa articular degenerativa.';
                    }
                    orientations.push({ title: 'Cirurgia bari√°trica', text: text });
                }

                if (data.tabagismo === 'fumante_diario') {
                    orientations.push({ title: 'Cessa√ß√£o do tabagismo', text: 'O tabagismo √© um fator de risco significativo para diversas doen√ßas, incluindo cardiovasculares e respirat√≥rias, e a cessa√ß√£o do tabagismo √© a a√ß√£o isolada de maior impacto na sa√∫de. Oferecer apoio da equipe (grupo de tabagismo, terapia de reposi√ß√£o de nicotina) √© priorit√°rio e pode colaborar com a perda de peso.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Psic√≥logo');
                }

                if ((data.tabagismo === 'ex_fumante' || data.tabagismo === 'fumante_ocasional' || data.tabagismo === 'fumante_diario') && data.q4 === 'apneia_limitacao' && !data.q19?.includes('asma_dpoc')) {
                    orientations.push({ title: 'Poss√≠vel Doen√ßa Pulmonar Obstrutiva Cr√¥nica', text: 'O hist√≥rico de tabagismo associado √† falta de ar que impede o aumento da atividade f√≠sica pode indicar a presen√ßa de Doen√ßa Pulmonar Obstrutiva Cr√¥nica (DPOC), que deve ser investigada.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Pneumologista');
                }

                if (scores.AF >= 60) {
                    let text = 'A pontua√ß√£o indica que o sedentarismo e o baixo gasto energ√©tico s√£o um ponto central. ';
                    if (data.q3 === "3") text += 'O longo tempo sentado(a) no dia a dia √© um fator de risco independente e precisa de ser abordado, quebrando os per√≠odos com pequenas pausas para se movimentar. ';

                    if (data.q4 === 'falta_tempo') {
                        text += 'A "falta de tempo" √© a barreira principal. A estrat√©gia mais eficaz n√£o √© pensar em "ir √† academia", mas em "acumular movimento" ao longo do dia: usar escadas, descer um ponto de √¥nibus antes, fazer pausas ativas de 5 minutos no trabalho. O foco √© a consist√™ncia, n√£o a intensidade.';
                    } else if (data.q4 === 'nao_gosto') {
                        text += 'Como foi indicado n√£o gostar de exerc√≠cios, o foco deve ser encontrar uma atividade que gere prazer (dan√ßa, artes marciais, esportes, caminhadas na natureza) para garantir a ades√£o. O objetivo √© mover o corpo de uma forma que traga alegria, n√£o que seja uma puni√ß√£o.';
                    } else if (data.q4 === 'falta_motivacao' && (hasDepressiveSymptoms || hasAnxietySymptoms)) {
                        text += 'A falta de motiva√ß√£o parece estar diretamente ligada aos sintomas de humor/ansiedade. A prioridade √© tratar a sa√∫de mental. Atividades leves, como caminhadas curtas, podem inclusive ajudar no tratamento, mas sem press√£o por performance.';
                    } else if (data.q4 === 'apneia_limitacao' && !data.q19?.includes('apneia') && !data.q19?.includes('asma_dpoc')) {
                        text += 'A maior barreira para ser mais ativo √© a falta de ar. Deve-se investigar se h√° asma, DPOC ou outras condi√ß√µes respirat√≥rias. O tratamento adequado dessas condi√ß√µes √© fundamental para conseguir aumentar a atividade f√≠sica.';
                    } else {
                        text += 'Come√ßar com pequenas metas, como incluir caminhadas curtas na rotina, √© um √≥timo primeiro passo para construir o h√°bito e a confian√ßa.'
                    }
                    orientations.push({ title: 'Estrat√©gias para aumentar a atividade f√≠sica', text: text });
                    professionals.add('Educador F√≠sico');
                }

                if (data.q4 === 'apneia_limitacao' && (data.q19?.includes('apneia') || data.q19?.includes('asma_dpoc'))) {
                    orientations.push({ title: 'Avalia√ß√£o respirat√≥ria', text: 'A falta de ar como barreira para a atividade f√≠sica, associada a um diagn√≥stico pr√©vio de apneia do sono ou de asma/DPOC, indica a necessidade de uma avalia√ß√£o m√©dica detalhada. O manejo adequado dessas condi√ß√µes respirat√≥rias √© crucial para melhorar a capacidade de se exercitar com seguran√ßa e conforto.' });
                    professionals.add('M√©dico de Fam√≠lia').add('Especialista em Sono').add('Pneumologista');
                }

                if (data.q4 === 'falta_tempo' && data.horas_trabalho && parseInt(data.horas_trabalho) > 44) {
                    orientations.push({ title: 'Otimizando a rotina', text: 'Foi identificada uma rotina de trabalho intensa como principal barreira para melhorar a atividade f√≠sica. O plano de a√ß√£o deve ser realista e focado em "micro-h√°bitos": incluir lanches saud√°veis planejados, usar escadas no trabalho, e realizar sess√µes curtas de exerc√≠cio (10-15 min) nos intervalos poss√≠veis.' });
                }

                if (data.q8 >= 2) {
                    orientations.push({ title: 'Aumentar a ingesta h√≠drica', text: 'H√° um consumo di√°rio de √°gua menor que 1,6 litro. Baixa ingesta h√≠drica prejudica o metabolismo, a saciedade, a fun√ß√£o renal e pode aumentar o consumo de bebidas cal√≥ricas. √â importante aumentar a hidrata√ß√£o, <strong>mesmo sem estar com sede</strong>; uma possibilidade √© ativar um lembrete para beber √°gua no celular para alertar a cada hora e criar o h√°bito de estar sempre com uma garrafa de √°gua por perto, de prefer√™ncia que contenha uma capacidade de aproximadamente 2 litros.' });
                }

                if (scores.AL >= 60) {
                    let text = 'O padr√£o alimentar parece ser um fator de grande impacto. A base deve ser priorizar "comida de verdade" e reduzir o consumo de ultraprocessados. ';
                    if (data.q5 >= 2 && data.q3 === "3") {
                        text += 'A combina√ß√£o de longos per√≠odos sentado com consumo frequente de ultraprocessados sugere um padr√£o que precisa de aten√ß√£o. Planejar lanches saud√°veis (frutas, castanhas) pode ajudar a evitar o consumo autom√°tico desses produtos. ';
                    }
                    if (data.q9 >= 2 && data.q14 >= 3) {
                        text += 'O estresse parece ser um gatilho importante para o "comer sem fome". Desenvolver outras ferramentas para lidar com o estresse (medita√ß√£o, hobbies, respira√ß√£o) √© fundamental para que a comida n√£o seja a √∫nica v√°lvula de escape. ';
                    }
                    if (data.q9 >= 2) {
                        text += 'Foi identificado que o ambiente e os gatilhos externos (ver comida, cheiros) influenciam as escolhas. Estrat√©gias de "arquitetura de escolhas" podem ajudar: deixar frutas vis√≠veis, n√£o ter ultraprocessados em casa, planejar o que comer antes de ir a eventos sociais.'
                    }
                    if (data.q17 >= 2) {
                        text += 'O uso da comida como conforto emocional √© um ponto chave. O trabalho terap√™utico deve focar em desenvolver um "card√°pio" de outras estrat√©gias n√£o-alimentares para lidar com as emo√ß√µes (ex: ouvir m√∫sica, conversar com algu√©m, caminhar, escrever).'
                    }
                    if (data.preparaRefeicoes === 'delivery') {
                        text += 'O fato de depender de delivery para as refei√ß√µes principais dificulta o controle sobre os ingredientes e por√ß√µes. <strong>Aprender a preparar refei√ß√µes simples</strong> em casa, mesmo que r√°pidas, pode melhorar significativamente a qualidade da alimenta√ß√£o.';
                    }
                    orientations.push({ title: 'Melhorando o padr√£o alimentar', text: text });
                    professionals.add('Nutricionista').add('M√©dico de Fam√≠lia');
                }
                if (hasTriedManyThings && data.q10 >= 2) {
                    orientations.push({ title: 'Ciclo de restri√ß√£o e perda de controle', text: 'O hist√≥rico de m√∫ltiplas tentativas de dietas restritivas, combinado com a sensa√ß√£o de perda de controle, sugere que uma abordagem n√£o-prescritiva e focada no comportamento alimentar (como o "comer intuitivo") pode ser mais ben√©fica do que mais uma dieta. O foco √© fazer as pazes com a comida.' });
                    professionals.add('Nutricionista').add('Psic√≥logo');
                }

                if (scores.SM >= 60) {
                    let text = 'Aspectos emocionais s√£o preponderantes. Cuidar da sa√∫de mental √© a base para conseguir realizar outras mudan√ßas de forma sustent√°vel. ';
                    if (hasPoorSleep && !data.q19?.includes('apneia')) text += 'A <strong>m√° qualidade do sono</strong>, em particular, tem um impacto direto no humor, nos horm√¥nios da fome e nas escolhas alimentares. A higiene do sono deve ser uma prioridade e aconselha-se investigar a exist√™ncia de apneia do sono. ';
                    if (data.q13 >= 2) text += 'A insatisfa√ß√£o com a imagem corporal pode levar a um ciclo de autocr√≠tica e comportamentos restritivos. Trabalhar a aceita√ß√£o e o respeito pelo corpo √© crucial. O m√©todo <strong>HAES</strong> (Sa√∫de em Todos os Tamanhos) √© uma abordagem que defende que a sa√∫de e o bem-estar podem ser alcan√ßados e mantidos independentemente do peso corporal, focando em comportamentos saud√°veis, aceita√ß√£o do corpo e justi√ßa social em vez da perda de peso como objetivo principal ';
                    if (data.q14 >= 3) text += 'O <strong>manejo do estresse √© uma prioridade</strong>. Aconselha-se investigar fontes de estresse, avaliar Pr√°ticas Integrativas (PICS) dispon√≠veis e considerar psicoterapia para desenvolver ferramentas eficazes de enfrentamento. ';
                    if (data.q16?.includes('dieta')) text += 'O hist√≥rico de dietas restritivas pode ter contribu√≠do para uma rela√ß√£o problem√°tica com a comida. Abordagens de <strong>nutri√ß√£o comportamental</strong>, comer intuitivo, reeduca√ß√£o alimentar sustent√°vel e o respeito aos sinais de fome e saciedade s√£o recomendadas. ';
                    if (data.q17 >= 3) text += 'O uso da comida como conforto emocional √© um ponto chave. O trabalho terap√™utico deve focar em desenvolver um "repert√≥rio emocional" de outras <strong>estrat√©gias n√£o-alimentares para lidar com as emo√ß√µes</strong> (ex: ouvir m√∫sica, conversar com algu√©m, caminhar, escrever).';
                    orientations.push({ title: 'Cuidado com a sa√∫de mental', text: text });
                    professionals.add('Psic√≥logo').add('Psiquiatra');
                }

                if (scores.MG >= 60) {
                    let text = 'Fatores metab√≥licos, gen√©ticos ou condi√ß√µes de sa√∫de parecem ter uma influ√™ncia significativa. √â fundamental um acompanhamento m√©dico pr√≥ximo para otimizar o tratamento de condi√ß√µes existentes e definir expectativas realistas para o manejo do peso. ';
                    if (data.q19?.includes('desconhecediagnostico')) text += 'A investiga√ß√£o de condi√ß√µes metab√≥licas √© uma prioridade para entender melhor os desafios enfrentados. Al√©m da avalia√ß√£o cl√≠nica, pode ser necess√°rio solicitar exames laboratoriais para avalia√ß√£o detalhada, como <strong>glicemia em jejum, perfil lip√≠dico, insulina em jejum, TSH, TGO e TGP</strong>. ';
                    if (data.q19?.includes('desconhecediagnostico') && data.sexo === 'feminino') text += 'A investiga√ß√£o deve incluir tamb√©m a avalia√ß√£o para <strong>S√≠ndrome dos Ov√°rios Polic√≠sticos</strong>, uma condi√ß√£o comum que impacta o metabolismo e o peso em mulheres. ';
                    if (data.q19?.includes('desconhecediagnostico') && hasPoorSleep) text += 'Considere tamb√©m solicitar uma <strong>polissonografia</strong> para avaliar a possibilidade de S√≠ndrome da Apneia e Hipopneia Obstrutiva do Sono, que pode afetar significativamente o metabolismo e a capacidade de perder peso. ';
                    orientations.push({ title: 'Manejo cl√≠nico e metab√≥lico', text: text });
                    professionals.add('M√©dico de Fam√≠lia').add('Endocrinologista');
                }

                if (gatilhoFibromialgia || data.q19?.includes('fibromialgia')) {
                    orientations.push({ title: 'Abordagem multimodal da dor cr√¥nica', text: 'O manejo da obesidade passa pelo manejo da dor. Requer abordagem multimodal: exerc√≠cio f√≠sico de baixo impacto, higiene do sono e medicamentos para dor cr√¥nica central (como amitriptilina, pregabalina, duloxetina).' });
                    professionals.add('M√©dico de Fam√≠lia').add('Reumatologista').add('Fisioterapeuta').add('Psic√≥logo');
                }

                if (data.q21 === '6') {
                    orientations.push({ title: 'Esfor√ßo e frustra√ß√£o', text: 'Devemos validar o sentimento de esfor√ßo e frustra√ß√£o ("eu me esfor√ßo e mesmo assim n√£o emagre√ßo"). Fatores metab√≥licos/gen√©ticos podem tornar o processo mais lento, mas n√£o imposs√≠vel. √â importante focar em <strong>metas de sa√∫de e n√£o s√≥ de peso</strong>.' });
                    professionals.add('M√©dico de Fam√≠lia');
                }

                if (data.q22 <= 4) {
                    orientations.push({ title: 'Aumentando a motiva√ß√£o', text: 'A motiva√ß√£o para a mudan√ßa de h√°bitos est√° baixa (fase de pr√©-contempla√ß√£o). √â importante aplicar a entrevista motivacional: explorar os motivos pessoais para a mudan√ßa, ambival√™ncias e conectar as metas de sa√∫de a valores significativos. Estrat√©gias como <strong>definir pequenas recompensas n√£o alimentares</strong> para cada conquista podem ajudar a aumentar a motiva√ß√£o ao longo do tempo.' });
                }

                if (data.q24 === 'estetica') {
                    orientations.push({ title: 'Motiva√ß√£o focada na est√©tica', text: 'Foi indicado que o motivo principal para a mudan√ßa de h√°bitos √© "melhorar a apar√™ncia e autoestima". Embora este seja um objetivo v√°lido, √© importante tamb√©m conectar as mudan√ßas a metas de sa√∫de mais amplas para garantir uma motiva√ß√£o sustent√°vel e evitar frustra√ß√µes relacionadas ao peso e √† imagem corporal.' });
                }

                if (data.q24 === 'outro') {
                    orientations.push({ title: 'Explorando motiva√ß√µes pessoais', text: 'Foi indicado que o motivo principal para a mudan√ßa de h√°bitos √© "outro". Recomenda-se explorar mais profundamente quais s√£o esses motivos pessoais e como eles podem ser conectados √†s metas de sa√∫de para fortalecer o compromisso com a mudan√ßa.' });
                }

                if (motivationDiscrepancy) {
                    orientations.push({ title: 'Construindo confian√ßa (autoefic√°cia)', text: 'Foi identificado que, embora a mudan√ßa seja muito importante, a confian√ßa em conseguir realiz√°-la est√° baixa. A melhor estrat√©gia √© <strong>focar em metas muito pequenas e realistas</strong> para construir um hist√≥rico de sucessos e aumentar gradualmente a auto-confian√ßa.' });
                }

                return { alerts, orientations, professionals, imc, narrative };
            }

            function generateNarrative(scores, data) {
                const nome = data.nome ? data.nome.split(' ')[0] : 'O paciente';
                const idade = data.idade || 'idade n√£o informada';

                // Mapeia os focos para nomes amig√°veis
                const focusMap = { AF: 'Atividade F√≠sica', AL: 'Alimenta√ß√£o', SM: 'Sa√∫de Mental', MG: 'Metabolismo/Gen√©tica' };

                // Encontra os focos com maior pontua√ß√£o
                const sortedScores = Object.entries(scores).sort(([, a], [, b]) => b - a);
                const mainFocusKey = sortedScores[0][0];
                const secondFocusKey = sortedScores[1][0];

                let narrative = `${nome}, de ${idade} anos, tem resultados indicando que os principais pontos de aten√ß√£o est√£o nos dom√≠nios de <strong>${focusMap[mainFocusKey]}</strong> e, secundariamente, em <strong>${focusMap[secondFocusKey]}</strong>. `;

                // Adiciona detalhes contextuais
                if (mainFocusKey === 'AL' && parseInt(data.q10, 10) >= 3) {
                    narrative += "A percep√ß√£o de perda de controle alimentar √© um fator relevante. ";
                }
                if (mainFocusKey === 'SM' && (parseInt(data.q11, 10) >= 4 || parseInt(data.q12, 10) >= 4)) {
                    narrative += "Sintomas de humor e ansiedade parecem ter um impacto significativo na rotina. ";
                }
                if (mainFocusKey === 'AF' && parseInt(data.q3, 10) === 3) {
                    narrative += "O tempo elevado em comportamento sedent√°rio √© um desafio importante a ser abordado. ";
                }
                if (mainFocusKey === 'MG' && parseInt(data.q18, 10) >= 2) {
                    narrative += "O hist√≥rico familiar sugere uma predisposi√ß√£o gen√©tica que deve ser considerada no plano de cuidados. ";
                }

                // Adiciona a parte de Motiva√ß√£o
                const motivacao = parseInt(data.q22, 10);
                const confianca = parseInt(data.q23, 10);
                const q24Map = {
                    'saude': 'melhorar a sa√∫de e evitar doen√ßas', 'disposicao': 'ter mais disposi√ß√£o e energia',
                    'estetica': 'melhorar a apar√™ncia e autoestima', 'medica': 'atender a uma recomenda√ß√£o m√©dica', 'outro': 'outro motivo espec√≠fico'
                };
                const motivoPrincipal = q24Map[data.q24] || 'n√£o informado';

                let motivacaoTexto = '';
                if (motivacao >= 7) motivacaoTexto = 'uma alta import√¢ncia';
                else if (motivacao >= 4) motivacaoTexto = 'uma import√¢ncia moderada';
                else motivacaoTexto = 'uma baixa import√¢ncia';

                let confiancaTexto = '';
                if (confianca >= 7) confiancaTexto = 'e sente-se bastante confiante';
                else if (confianca >= 4) confiancaTexto = 'e sente-se moderadamente confiante';
                else confiancaTexto = 'e sente-se pouco confiante';

                narrative += `Atualmente, ${nome} atribui <strong>${motivacaoTexto} (nota ${motivacao}/10)</strong> √† mudan√ßa de h√°bitos, ${confiancaTexto} <strong>(nota ${confianca}/10)</strong> de que pode realizar as mudan√ßas necess√°rias. Seu principal objetivo √© <strong>${motivoPrincipal}</strong>.`

                return narrative;
            }

            async function generatePDF() {
                const { jsPDF } = window.jspdf;
                const reportElement = document.getElementById('report-to-print');

                // Temporariamente torna todas as se√ß√µes vis√≠veis para o PDF
                const collapsibles = reportElement.querySelectorAll('.collapsible-content');
                collapsibles.forEach(el => el.classList.add('expanded'));

                await new Promise(resolve => setTimeout(resolve, 500)); // Espera a anima√ß√£o de expans√£o

                html2canvas(reportElement, {
                    scale: 2, // Melhora a qualidade da imagem
                    useCORS: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const imgWidth = pdfWidth - 20; // com margens
                    const imgHeight = imgWidth / ratio;

                    let heightLeft = imgHeight;
                    let position = 10; // margem superior

                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight + 10; // Ajusta a posi√ß√£o para a nova p√°gina
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= (pdfHeight - 20);
                    }

                    // Esconde as se√ß√µes novamente
                    collapsibles.forEach(el => el.classList.remove('expanded'));

                    pdf.save(`Relatorio_IAMO_${document.getElementById('nome').value || 'Paciente'}.pdf`);
                });
            }

            function exportData(scores, data) {
                const exportObject = {
                    timestamp: new Date().toISOString(),
                    dados_iniciais: { nome: data.nome, idade: data.idade, sexo: data.sexo, peso: data.peso, altura: data.altura, tabagismo: data.tabagismo, etilismo: data.etilismo, ocupacao: data.ocupacao, horas_trabalho: data.horas_trabalho, transporte: data.transporte, escolaridade: data.escolaridade },
                    respostas: data,
                    scores_percentual: scores
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObject, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `iamo_resultado_${data.nome.replace(/\s+/g, '_') || 'paciente'}_${new Date().getTime()}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            setupQuestions();
            updateUI();
        });
    </script>
</body>
</html>
